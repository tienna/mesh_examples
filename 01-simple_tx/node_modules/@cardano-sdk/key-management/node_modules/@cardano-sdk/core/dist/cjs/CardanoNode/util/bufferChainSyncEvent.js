"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.bufferChainSyncEvent = void 0;
const rxjs_1 = require("rxjs");
const bufferChainSyncEvent = (length) => (source$) => new rxjs_1.Observable((subscriber) => {
    const buffer = [];
    let lastPull;
    let unsubscribed = false;
    let subscriberReady = true;
    let sourceCompleted = false;
    let sourceError;
    const next = () => {
        if (unsubscribed)
            return;
        if (buffer.length < length && lastPull) {
            lastPull();
            lastPull = undefined;
        }
        if (!subscriberReady)
            return;
        if (buffer.length === 0) {
            if (sourceCompleted)
                return subscriber.complete();
            if (sourceError)
                return subscriber.error(sourceError);
            return;
        }
        const value = buffer.shift();
        subscriberReady = false;
        subscriber.next({
            ...value,
            requestNext: () => {
                subscriberReady = true;
                next();
            }
        });
    };
    const subscription = source$.subscribe({
        complete: () => {
            sourceCompleted = true;
            next();
        },
        error: (error) => {
            sourceError = error;
            next();
        },
        next: (value) => {
            lastPull = value.requestNext;
            buffer.push(value);
            next();
        }
    });
    return () => {
        subscription.unsubscribe();
        unsubscribed = true;
    };
});
exports.bufferChainSyncEvent = bufferChainSyncEvent;
//# sourceMappingURL=bufferChainSyncEvent.js.map